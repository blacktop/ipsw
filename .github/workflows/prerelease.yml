name: Pre-Release

on:
  push:
    branches: [ master ]
  workflow_dispatch:

permissions:
  contents: write
  actions: read

concurrency:
  group: prerelease-${{ github.ref }}
  cancel-in-progress: true

env:
  PRERELEASE_TAG: prerelease

jobs:
  goreleaser:
    # macOS runner (Apple Silicon) builds both arches then lipo to universal
    runs-on: macos-latest
    if: github.ref_type == 'branch' && github.ref == 'refs/heads/master'

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: stable
          cache: true

      - name: Install Rosetta (for x86_64 cross-build)
        run: softwareupdate --install-rosetta --agree-to-license || true

      - name: Install dependencies (arm64)
        run: |
          brew install --quiet pkg-config libusb unicorn libheif
        env:
          HOMEBREW_NO_AUTO_UPDATE: 1

      - name: Install x86_64 Homebrew + deps
        run: |
          mkdir /tmp/homebrew
          cd /tmp; curl -L https://github.com/Homebrew/brew/tarball/master | tar xz --strip 1 -C homebrew
          sudo mv /tmp/homebrew /usr/local/homebrew
          arch -x86_64 /usr/local/homebrew/bin/brew install --quiet unicorn libusb libheif pkg-config
        env:
          HOMEBREW_NO_AUTO_UPDATE: 1

      - name: Delete existing prerelease/tag
        run: gh release delete "$PRERELEASE_TAG" -y --cleanup-tag || true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run GoReleaser (prerelease)
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: "~> v2"
          args: release --clean --skip=announce --config hack/goreleaser/darwin.yml --config hack/goreleaser/prerelease.yml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GORELEASER_CURRENT_TAG: ${{ env.PRERELEASE_TAG }}

      - name: Upload dist artifacts (for debugging)
        if: failure()
        uses: actions/upload-artifact@v5
        with:
          name: prerelease-dist
          path: dist/**
